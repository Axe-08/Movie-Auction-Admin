<!DOCTYPE html>
<html>

<head>
    <title>Movie Auction Admin Dashboard</title>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <style>
        /* Base styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            line-height: 1.6;
        }

        /* Layout */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        /* Components */
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tab {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #e0e0e0;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #2196f3;
            color: white;
        }

        /* Buttons and Inputs */
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #2196f3;
            color: white;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #1976d2;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        button.danger {
            background: #f44336;
        }

        button.danger:hover {
            background: #d32f2f;
        }

        input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
            max-width: 300px;
        }

        /* Status Indicators */
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            min-width: 80px;
            display: inline-block;
        }

        .status.available {
            background: #4caf50;
            color: white;
        }

        .status.sold {
            background: #f44336;
            color: white;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f5f5f5;
            font-weight: bold;
        }

        /* Login Modal */
        .admin-login {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-box {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 400px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        /* Event Log */
        .event-log {
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .log-entry {
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-family: monospace;
        }

        .log-entry.error {
            color: #f44336;
        }

        .log-entry.success {
            color: #4caf50;
        }

        .log-entry.info {
            color: #2196f3;
        }

        .catalogue-header {
            cursor: pointer;
            user-select: none;
        }

        .catalogue-header:hover {
            background-color: #f0f0f0;
        }

        .sort-indicator {
            opacity: 0.3;
        }

        .catalogue-header.sorted .sort-indicator {
            opacity: 1;
        }

        .catalogue-header.sorted.asc .sort-indicator {
            content: "↑";
        }

        .catalogue-header.sorted.desc .sort-indicator {
            content: "↓";
        }

        .pagination {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            color: #333;
        }

        .pagination button.active {
            background: #2196f3;
            color: white;
            border-color: #2196f3;
        }

        .pagination button:disabled {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        .counter {
            color: #666;
            font-size: 14px;
            padding: 8px;
        }
    </style>
</head>

<body>
    <!-- Admin Login -->
    <div id="adminLogin" class="admin-login">
        <div class="login-box">
            <h2 class="mb-20">Admin Authentication</h2>
            <div class="mb-20">
                <input type="password" id="adminCode" placeholder="Enter Admin Access Code" />
            </div>
            <button id="loginButton" style="width: 100%;">Login</button>
            <p id="loginError" class="log-entry error hidden mt-10"></p>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="adminDashboard" class="hidden">
        <div class="header">
            <h1>Movie Auction Admin Dashboard</h1>
            <div class="flex">
                <span id="connectionStatus" class="status">Connecting...</span>
                <button onclick="logout()" class="danger">Logout</button>
            </div>
        </div>

        <div class="container">
            <div class="nav-tabs">
                <button class="tab active" data-tab="auction">Live Auction</button>
                <button class="tab" data-tab="catalogue">Catalogue</button>
                <button class="tab" data-tab="leaderboard">Leaderboard</button>
                <button class="tab" data-tab="logs">Event Log</button>
            </div>

            <!-- Auction Tab -->
            <div id="auctionTab" class="tab-content">
                <div class="grid">
                    <!-- Current Item Section -->
                    <div class="card">
                        <div class="flex mb-20">
                            <h2>Current Item</h2>
                            <div class="flex">
                                <button onclick="previousItem()" id="prevBtn">←</button>
                                <span id="itemCounter">1/10</span>
                                <button onclick="nextItem()" id="nextBtn">→</button>
                            </div>
                        </div>

                        <div id="currentItem" class="mb-20">
                            <h3 id="itemName">Loading...</h3>
                            <div class="flex mb-20">
                                <div>Category: <span id="itemCategory">-</span></div>
                                <div>Rating: <span id="itemRating">-</span></div>
                                <div>Status: <span id="itemStatus" class="status">-</span></div>
                            </div>
                            <div class="mb-20">
                                <div>Base Price: ₹<span id="basePrice">0</span> Cr</div>
                                <div>Current Bid: ₹<span id="currentBid">0</span> Cr</div>
                            </div>
                            <div class="flex">
                                <input type="number" id="newBid" placeholder="Set Price (in Cr)" step="0.25" min="0" />
                                <button onclick="setNewBid()">Set Price</button>
                            </div>
                        </div>
                    </div>

                    <!-- Production Houses Section -->
                    <div class="card">
                        <h2 class="mb-20">Production Houses</h2>
                        <div id="housesList">
                            <!-- Houses will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Catalogue Tab -->
            <div id="catalogueTab" class="tab-content hidden">
                <div class="card">
                    <div class="flex mb-20">
                        <h2>Crew Catalogue</h2>
                        <div class="flex">
                            <input type="text" placeholder="Search crew members..."
                                onkeyup="filterCatalogue(this.value)" />
                            <span id="catalogueCounter" class="counter"></span>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th class="catalogue-header" data-field="name" onclick="sortCatalogue('name')">
                                    Name <span class="sort-indicator">↕</span>
                                </th>
                                <th class="catalogue-header" data-field="category" onclick="sortCatalogue('category')">
                                    Category <span class="sort-indicator">↕</span>
                                </th>
                                <th class="catalogue-header" data-field="rating" onclick="sortCatalogue('rating')">
                                    Rating <span class="sort-indicator">↕</span>
                                </th>
                                <th class="catalogue-header" data-field="base_price"
                                    onclick="sortCatalogue('base_price')">
                                    Base Price (Cr) <span class="sort-indicator">↕</span>
                                </th>
                                <th class="catalogue-header" data-field="current_bid"
                                    onclick="sortCatalogue('current_bid')">
                                    Current Bid (Cr) <span class="sort-indicator">↕</span>
                                </th>
                                <th class="catalogue-header" data-field="status" onclick="sortCatalogue('status')">
                                    Status <span class="sort-indicator">↕</span>
                                </th>
                                <th class="catalogue-header" data-field="buyer_name"
                                    onclick="sortCatalogue('buyer_name')">
                                    Buyer <span class="sort-indicator">↕</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="catalogueList">
                        </tbody>
                    </table>
                    <div id="cataloguePagination" class="pagination"></div>
                </div>
            </div>

            <!-- Leaderboard Tab -->
            <div id="leaderboardTab" class="tab-content hidden">
                <div class="card">
                    <h2 class="mb-20">Current Standings</h2>
                    <div id="leaderboard">
                        <!-- Leaderboard will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Logs Tab -->
            <div id="logsTab" class="tab-content hidden">
                <div class="card">
                    <h2 class="mb-20">Event Log</h2>
                    <div id="eventLog" class="event-log">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State Management
        let socket = null;
        let authenticated = false;
        let crewMembers = [];
        let currentCrewIndex = 0;
        let houses = [];
        const AuctionState = {
            currentCrewIndex: 0,
            crewMembers: [],
            houses: [],

            setCurrentCrew(index) {
                this.currentCrewIndex = index;
                updateCurrentItem();
                updateHousesList();
            },

            updateCrewMember(crewId, updates) {
                const index = this.crewMembers.findIndex(c => c.id === crewId);
                if (index !== -1) {
                    this.crewMembers[index] = { ...this.crewMembers[index], ...updates };
                    if (index === this.currentCrewIndex) {
                        updateCurrentItem();
                    }
                    updateCatalogue();
                }
            }
        };

        let catalogueState = {
            currentPage: 1,
            itemsPerPage: 10,
            sortField: null,
            sortDirection: 'asc',
            filterText: ''
        };

        function setNewBid() {
            const newBidInput = document.getElementById('newBid');
            const newBid = parseFloat(newBidInput.value);
            if (!newBid || isNaN(newBid)) {
                log('Invalid bid amount', 'error');
                return;
            }

            const bidInRupees = newBid * 10000000;
            const crew = crewMembers[currentCrewIndex];

            if (!crew) {
                log('No crew member selected', 'error');
                return;
            }

            if (bidInRupees <= crew.current_bid) {
                log('New bid must be higher than current bid', 'error');
                return;
            }

            // Update local state first
            crewMembers[currentCrewIndex].current_bid = bidInRupees;
            updateCurrentItem();

            // Then emit socket event
            if (socket) {
                socket.emit('bid_update', {
                    crewId: crew.id,
                    newBid: bidInRupees
                }, (response) => {
                    if (response && response.error) {
                        log(`Bid update failed: ${response.error}`, 'error');
                        // Revert local state if server update failed
                        loadInitialData();
                    }
                });
            }
            newBidInput.value = '';
        }
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            const tabContent = document.getElementById(`${tabName}Tab`);
            const tabButton = document.querySelector(`.tab[onclick="showTab('${tabName}')"]`);

            if (tabContent) tabContent.classList.remove('hidden');
            if (tabButton) tabButton.classList.add('active');
        }

        function log(message, type = 'info') {
            const logContainer = document.getElementById('eventLog');
            if (!logContainer) return;

            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            logContainer.insertBefore(entry, logContainer.firstChild);
        }

        function assignCrewToHouse(houseId) {
            const crew = crewMembers[currentCrewIndex];
            const token = localStorage.getItem('adminToken');

            if (!crew || crew.status === 'sold') {
                log('Crew member not available for sale', 'error');
                return;
            }

            if (!token) {
                log('Not authenticated', 'error');
                logout();
                return;
            }

            // Disable the assign button during the request
            const assignButton = document.querySelector(`button[onclick="assignCrewToHouse(${houseId})"]`);
            if (assignButton) assignButton.disabled = true;

            fetch('http://localhost:3001/api/sell', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    crewMemberId: crew.id,
                    productionHouseId: houseId,
                    purchasePrice: crew.current_bid
                })
            })
                .then(response => {
                    if (response.status === 401) {
                        log('Session expired', 'error');
                        logout();
                        return null;
                    }
                    return response.json();
                })
                .then(data => {
                    if (data) {
                        if (data.success) {
                            log(`Successfully sold crew member to house ${houseId}`, 'success');
                            // Update local state
                            crewMembers[currentCrewIndex].status = 'sold';
                            updateCurrentItem();
                            loadInitialData().then(() => {
                                // Move to next available crew member
                                const nextAvailableIndex = crewMembers.findIndex((c, index) =>
                                    index > currentCrewIndex && c.status !== 'sold'
                                );
                                if (nextAvailableIndex !== -1) {
                                    currentCrewIndex = nextAvailableIndex;
                                    updateCurrentItem();
                                }
                            });
                        } else {
                            log(`Failed to sell crew member: ${data.error}`, 'error');
                        }
                    }
                })
                .catch(error => {
                    log(`Error selling crew member: ${error.message}`, 'error');
                })
                .finally(() => {
                    if (assignButton) assignButton.disabled = false;
                });
        }

        function showError(message) {
            const errorElem = document.getElementById('loginError');
            errorElem.textContent = message;
            errorElem.classList.remove('hidden');
            setTimeout(() => errorElem.classList.add('hidden'), 3000);
        }

        function showDashboard() {
            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
        }

        function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                log('Not authenticated', 'error');
                logout();
                return Promise.reject(new Error('Not authenticated'));
            }

            return fetch(url, {
                ...options,
                headers: {
                    ...options.headers,
                    'Authorization': `Bearer ${token}`
                }
            }).then(response => {
                if (response.status === 401) {
                    log('Session expired', 'error');
                    logout();
                    return null;
                }
                return response;
            });
        }

        function updateCurrentItem() {
            const crew = crewMembers[currentCrewIndex];
            if (!crew) return;

            // Debug logging
            console.log('Current Crew:', crew);
            console.log('Current Crew Status:', crew.status);
            console.log('Current Crew Bid:', crew.current_bid);

            // Update basic crew information
            document.getElementById('itemName').textContent = crew.name;
            document.getElementById('itemCategory').textContent = crew.category;
            document.getElementById('itemRating').textContent = crew.rating;
            document.getElementById('itemStatus').textContent = crew.status.toUpperCase();
            document.getElementById('itemStatus').className = `status ${crew.status}`;

            // Update price information (converting to Crores)
            document.getElementById('basePrice').textContent = (crew.base_price / 10000000).toFixed(2);
            document.getElementById('currentBid').textContent = (crew.current_bid / 10000000).toFixed(2);

            // Update item counter
            document.getElementById('itemCounter').textContent = `${currentCrewIndex + 1}/${crewMembers.length}`;

            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentCrewIndex === 0;
            document.getElementById('nextBtn').disabled = currentCrewIndex === crewMembers.length - 1;

            // Update houses list to reflect current crew state
            updateHousesList();
        }

        function nextItem() {
            if (currentCrewIndex < crewMembers.length - 1) {
                currentCrewIndex++;
                console.log('Moving to next crew member:', currentCrewIndex);
                updateCurrentItem();
            }
        }

        function previousItem() {
            if (currentCrewIndex > 0) {
                currentCrewIndex--;
                console.log('Moving to previous crew member:', currentCrewIndex);
                updateCurrentItem();
            }
        }


        function logout() {
            localStorage.removeItem('adminToken');
            if (socket) {
                socket.disconnect();
            }
            socket = null;
            authenticated = false;
            crewMembers = [];
            currentCrewIndex = 0;
            houses = [];

            // Reset UI
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('adminLogin').classList.remove('hidden');
            document.getElementById('adminCode').value = '';
        }

        function loadInitialData() {
            return Promise.all([
                fetchWithAuth('http://localhost:3001/api/crew').then(r => r && r.json()),
                fetchWithAuth('http://localhost:3001/api/leaderboard').then(r => r && r.json())
            ])
                .then(([crew, leaderboard]) => {
                    if (!crew || !leaderboard) return;

                    // Create a map of house IDs to names for quick lookup
                    const houseMap = new Map(leaderboard.map(house => [house.id, house.name]));

                    crewMembers = crew.map(member => ({
                        ...member,
                        status: member.status || 'available',
                        current_bid: member.current_bid || member.base_price,
                        buyer_name: member.production_house_id ? houseMap.get(member.production_house_id) : null
                    }));
                    houses = leaderboard;

                    currentCrewIndex = crewMembers.findIndex(crew => crew.status !== 'sold');
                    if (currentCrewIndex === -1) currentCrewIndex = 0;

                    console.log('Initial data loaded, current crew index:', currentCrewIndex);
                    updateAllDisplays();
                })
                .catch(error => {
                    log('Failed to load initial data: ' + error.message, 'error');
                });
        }

        // Socket Management
        function initializeSocket(token) {
            if (socket) {
                socket.disconnect();
            }

            socket = io('http://localhost:3001', {
                auth: { token },
                transports: ['websocket'],
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000
            });

            socket.on('connect_error', (error) => {
                console.log('Socket connection error:', error);
                log('Connection error: Retrying...', 'error');
            });

            socket.on('reconnect', (attemptNumber) => {
                log(`Reconnected after ${attemptNumber} attempts`, 'success');
                // Reload data after reconnection
                loadInitialData();
            });

            socket.on('connect', () => {
                document.getElementById('connectionStatus').textContent = 'Connected';
                document.getElementById('connectionStatus').className = 'status available';
                log('Connected to server', 'success');
            });

            socket.on('disconnect', () => {
                document.getElementById('connectionStatus').textContent = 'Disconnected';
                document.getElementById('connectionStatus').className = 'status sold';
                log('Disconnected from server', 'error');
            });

            socket.on('bid_update', (data) => {
                const crewIndex = crewMembers.findIndex(c => c.id === data.crewId);
                if (crewIndex !== -1) {
                    crewMembers[crewIndex].current_bid = data.newBid;
                    if (crewIndex === currentCrewIndex) {
                        updateCurrentItem();
                    }
                    updateCatalogue();
                    log(`Bid updated: ₹${(data.newBid / 10000000).toFixed(2)} Cr`, 'info');
                }
            });
            socket.on('house_budget_updated', (data) => {
                // Update local house data
                const house = houses.find(h => h.id === data.houseId);
                if (house) {
                    house.budget = data.budget;
                    updateHousesList();
                }
            });

            socket.on('sale_complete', (data) => {
                console.log('Sale completed:', data);

                // Update local crew member status
                const soldCrewIndex = crewMembers.findIndex(c => c.id === data.crewMemberId);
                if (soldCrewIndex !== -1) {
                    crewMembers[soldCrewIndex].status = 'sold';

                    // Update the buying house's data
                    const buyingHouse = houses.find(h => h.id === data.productionHouseId);
                    if (buyingHouse) {
                        buyingHouse.budget -= data.purchasePrice;
                        buyingHouse.crew_count = (buyingHouse.crew_count || 0) + 1;

                        // Update average rating
                        const soldCrew = crewMembers[soldCrewIndex];
                        const totalRating = (buyingHouse.average_rating || 0) * (buyingHouse.crew_count - 1) + soldCrew.rating;
                        buyingHouse.average_rating = totalRating / buyingHouse.crew_count;
                    }

                    // Update displays
                 updateAllDisplays();
                }

                log(`Sale completed: ₹${(data.purchasePrice / 10000000).toFixed(2)} Cr`, 'success');
            });

            // Add this to ensure state is properly initialized when data is loaded


        }

        // Data Management

        // Event Handlers
        function handleBidUpdate(data) {
            const crew = crewMembers.find(c => c.id === data.crewId);
            if (crew) {
                crew.current_bid = data.newBid;
                updateAllDisplays();
                log(`Bid updated: ₹${(data.newBid / 10000000).toFixed(2)} Cr`, 'info');
            }
        }

        function handleSaleComplete(data) {
            loadInitialData(); // Refresh all data
            log(`Sale completed: ₹${(data.purchasePrice / 10000000).toFixed(2)} Cr`, 'success');
        }

        function updateAllDisplays() {
            updateLeaderboard();
            updateCurrentItem();
            updateHousesList();
            updateCatalogue();
           
        }


        // Update display functions


        function updateHousesList() {
            const container = document.getElementById('housesList');
            if (!container) return;

            const currentCrew = crewMembers[currentCrewIndex];

            container.innerHTML = houses.map(house => {
                const canBuy = currentCrew &&
                    currentCrew.status === 'available' &&
                    house.budget >= (currentCrew.current_bid || currentCrew.base_price);

                return `
            <div class="card mb-20">
                <div class="flex mb-20">
                    <h3>${house.name}</h3>
                    <span class="status available">₹${(house.budget / 10000000).toFixed(2)} Cr</span>
                </div>
                <div class="flex">
                    <div>Crew Count: ${house.crew_count || 0}</div>
                    <div>Avg Rating: ${house.average_rating ? house.average_rating.toFixed(2) : 'N/A'}</div>
                </div>
                <div class="flex mt-10">
                    <button 
                        onclick="assignCrewToHouse(${house.id})"
                        ${!canBuy ? 'disabled' : ''}
                        class="${canBuy ? 'active' : 'disabled'}"
                    >
                        Assign Crew ${!canBuy ? '(Not Available)' : ''}
                    </button>
                </div>
            </div>
        `;
            }).join('');
        }

        function sortCatalogue(field) {
            if (catalogueState.sortField === field) {
                // Toggle direction if clicking same field
                catalogueState.sortDirection = catalogueState.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                catalogueState.sortField = field;
                catalogueState.sortDirection = 'asc';
            }
            updateCatalogue();
        }

        // Add this function for pagination
        function changeCataloguePage(page) {
            catalogueState.currentPage = page;
            updateCatalogue();
        }

        // Updated catalogue filtering function
        function filterCatalogue(text) {
            catalogueState.filterText = text.toLowerCase();
            catalogueState.currentPage = 1; // Reset to first page when filtering
            updateCatalogue();
        }

        function updateCatalogue() {
            const tbody = document.getElementById('catalogueList');
            const paginationContainer = document.getElementById('cataloguePagination');

            // Debug log to see crew data
            console.log('Crew members data:', crewMembers);

            // Filter the crew members
            let filteredCrew = crewMembers.filter(crew => {
                const searchText = catalogueState.filterText.toLowerCase();
                return (
                    crew.name.toLowerCase().includes(searchText) ||
                    crew.category.toLowerCase().includes(searchText) ||
                    (crew.buyer_name && crew.buyer_name.toLowerCase().includes(searchText))
                );
            });

            // Debug log for filtered crew
            console.log('Filtered crew:', filteredCrew);

            // Sort the filtered results
            if (catalogueState.sortField) {
                filteredCrew.sort((a, b) => {
                    let aValue = a[catalogueState.sortField];
                    let bValue = b[catalogueState.sortField];

                    // Handle numeric values
                    if (catalogueState.sortField === 'base_price' || catalogueState.sortField === 'current_bid') {
                        aValue = Number(aValue);
                        bValue = Number(bValue);
                    }

                    // Handle null/undefined buyer names
                    if (catalogueState.sortField === 'buyer_name') {
                        aValue = aValue || '';
                        bValue = bValue || '';
                    }

                    if (catalogueState.sortDirection === 'asc') {
                        return aValue > bValue ? 1 : -1;
                    } else {
                        return aValue < bValue ? 1 : -1;
                    }
                });
            }

            // Calculate pagination
            const totalPages = Math.ceil(filteredCrew.length / catalogueState.itemsPerPage);
            const startIndex = (catalogueState.currentPage - 1) * catalogueState.itemsPerPage;
            const paginatedCrew = filteredCrew.slice(startIndex, startIndex + catalogueState.itemsPerPage);

            // Debug log for paginated data
            console.log('Paginated crew:', paginatedCrew);

            // Update table content with explicit buyer name handling
            tbody.innerHTML = paginatedCrew.map(crew => {
                // Debug log for each crew member
                console.log('Processing crew member:', crew.name, 'Buyer:', crew.buyer_name);

                return `
        <tr>
            <td>${crew.name}</td>
            <td>${crew.category}</td>
            <td>${crew.rating}</td>
            <td>${(crew.base_price / 10000000).toFixed(2)}</td>
            <td>${(crew.current_bid / 10000000).toFixed(2)}</td>
            <td><span class="status ${crew.status}">${crew.status.toUpperCase()}</span></td>
            <td>${crew.buyer_name || (crew.status === 'sold' ? 'Unknown Buyer' : '-')}</td>
        </tr>
    `}).join('');

            // Update pagination controls
            paginationContainer.innerHTML = generatePaginationControls(totalPages);
        }

        function generatePaginationControls(totalPages) {
            if (totalPages <= 1) return '';

            let controls = [];

            // Previous button
            controls.push(`
        <button 
            onclick="changeCataloguePage(${catalogueState.currentPage - 1})"
            ${catalogueState.currentPage === 1 ? 'disabled' : ''}
        >Previous</button>
    `);

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (
                    i === 1 ||
                    i === totalPages ||
                    (i >= catalogueState.currentPage - 2 && i <= catalogueState.currentPage + 2)
                ) {
                    controls.push(`
                <button 
                    onclick="changeCataloguePage(${i})"
                    class="${i === catalogueState.currentPage ? 'active' : ''}"
                >${i}</button>
            `);
                } else if (
                    i === catalogueState.currentPage - 3 ||
                    i === catalogueState.currentPage + 3
                ) {
                    controls.push('<span>...</span>');
                }
            }

            // Next button
            controls.push(`
        <button 
            onclick="changeCataloguePage(${catalogueState.currentPage + 1})"
            ${catalogueState.currentPage === totalPages ? 'disabled' : ''}
        >Next</button>
    `);

            return controls.join('');
        }

        function updateLeaderboard() {
            const container = document.getElementById('leaderboard');
            container.innerHTML = houses
                .sort((a, b) => (b.average_rating || 0) - (a.average_rating || 0))
                .map(house => `
            <div class="card mb-20">
                <h3 class="mb-20">${house.name}</h3>
                <div class="grid grid-cols-2 gap-10">
                    <div>Budget: ₹${(house.budget / 10000000).toFixed(2)} Cr</div>
                    <div>Average Rating: ${house.average_rating ? house.average_rating.toFixed(2) : 'N/A'}</div>
                    <div>Total Crew: ${house.crew_count || 0}</div>
                    <div>Categories Filled: ${getCategoriesFilled(house)}/6</div>
                </div>
                <div class="mt-10">
                    ${generateRequirementsList(house)}
                </div>
            </div>
        `).join('');
        }


        // Utility functions

        function getCategoriesFilled(house) {
            const categories = ['lead_actors', 'supporting_actors', 'musicians', 'directors', 'nepo_kids', 'comedic_relief'];
            return categories.filter(cat => (house[cat] || 0) > 0).length;
        }

        function generateRequirementsList(house) {
            const requirements = [
                { name: 'Lead Actors', required: 3, current: house.lead_actors || 0 },
                { name: 'Supporting Actors', required: 2, current: house.supporting_actors || 0 },
                { name: 'Musicians', required: 1, current: house.musicians || 0 },
                { name: 'Directors', required: 1, current: house.directors || 0 },
                { name: 'Nepo Kids', required: 1, current: house.nepo_kids || 0 },
                { name: 'Comedic Relief', required: 1, current: house.comedic_relief || 0 }
            ];

            return `
        <div class="requirements-list">
            ${requirements.map(req => `
                <div class="requirement ${req.current >= req.required ? 'fulfilled' : 'pending'}">
                    ${req.name}: ${req.current}/${req.required}
                </div>
            `).join('')}
        </div>
    `;
        }
        document.addEventListener('DOMContentLoaded', function () {


            // Initialize event listeners
            document.getElementById('loginButton').addEventListener('click', authenticateAdmin);
            document.getElementById('adminCode').addEventListener('keyup', function (event) {
                if (event.key === 'Enter') authenticateAdmin();
            });

            // Setup tab navigation
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabName = this.getAttribute('data-tab');
                    showTab(tabName);
                });
            });

            // Navigation button
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabName = this.getAttribute('data-tab');
                    showTab(tabName);
                });
            });
            // Check for existing session
            const token = localStorage.getItem('adminToken');
            if (token) {
                verifyAndInitialize(token);
            }

            // Authentication Functions
            function authenticateAdmin() {
                const code = document.getElementById('adminCode').value;
                const loginButton = document.getElementById('loginButton');
                loginButton.textContent = 'Authenticating...';
                loginButton.disabled = true;

                fetch('http://localhost:3001/api/admin/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accessCode: code })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.token) {
                            // Add debug log to see the token we're storing
                            console.log('Storing token:', data.token);
                            localStorage.setItem('adminToken', data.token);
                            showDashboard();
                            initializeSocket(data.token);
                            loadInitialData();
                        } else {
                            showError(data.error || 'Invalid admin code');
                        }
                    })
                    .catch(error => {
                        showError('Authentication failed: ' + error.message);
                        console.error('Auth error:', error);
                    })
                    .finally(() => {
                        loginButton.textContent = 'Login';
                        loginButton.disabled = false;
                    });
            }
            function verifyAndInitialize(token) {
                // First, let's add a debug log to see what token we're working with
                console.log('Attempting to verify token:', token);

                fetch('http://localhost:3001/api/admin/verify', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,  // Make sure to use 'Bearer ' prefix
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        // Add debug logging to see the response status
                        console.log('Verify response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            showDashboard();
                            initializeSocket(token);
                            loadInitialData();
                        } else {
                            // If verification fails, clear token and show login
                            localStorage.removeItem('adminToken');
                            document.getElementById('adminLogin').classList.remove('hidden');
                            document.getElementById('adminDashboard').classList.add('hidden');
                        }
                    })
                    .catch(error => {
                        console.error('Verification error:', error);
                        localStorage.removeItem('adminToken');
                    });
            }

        });

    </script>
</body>

</html>